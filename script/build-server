#!/bin/sh

# Server build instructions:
# https://github.com/mongodb/mongo/blob/master/docs/building.md
# https://github.com/mongodb/mongo/wiki/Build-Mongodb-From-Source
# https://jira.mongodb.org/browse/HELP-13886

set -e

# Dependencies:
#
# apt-get install gcc-8 g++-8 python3-pip libssl-dev libcurl4-openssl-dev

if ! test -d ~/apps/exp/mongo; then
  mkdir -p ~/apps/exp
  git clone https://github.com/mongodb/mongo ~/apps/exp/mongo
else
  (cd ~/apps/exp/mongo && git fetch origin)
fi
cd ~/apps/exp/mongo
rm -rf build

version="$1"
if test -z "$version" || test "$version" = master; then
  branch=origin/master
elif echo "$version" |grep -q ^r; then
  branch=$version
elif echo "$version" |grep -q 4.4; then
  branch=origin/v4.4
elif echo "$version" |grep -q 4.4; then
  branch=origin/v4.4
elif echo "$version" |grep -q 4.0; then
  branch=origin/v4.0
else
  #echo "Unknown version $version" 1>&2
  #exit 1
  branch=origin/$version
fi

if test -d ~/apps/exp/mongo-enterprise-modules; then
  (cd ~/apps/exp/mongo-enterprise-modules && git fetch origin)
else
  git clone git@github.com:10gen/mongo-enterprise-modules ~/apps/exp/mongo-enterprise-modules
fi

(cd ~/apps/exp/mongo-enterprise-modules &&
git checkout $branch)

git checkout $branch

mkdir src/mongo/db/modules/
ln -sf ~/mongo-enterprise-modules src/mongo/db/modules/enterprise

if echo $version |fgrep -q 4.0; then
  pip install --user -r buildscripts/requirements.txt
else
  pip3 install --user -r etc/pip/compile-requirements.txt
fi

cpus=`</proc/cpuinfo grep ^processor |wc -l`
if test $cpus -gt 20; then
  jopt=-j20
elif test $cpus -gt 8; then
  jopt=-j8
elif test $cpus -gt 4; then
  jopt=-j4
elif test $cpus -gt 2; then
  jopt=-j2
else
  jopt=
fi

targets="mongo mongod mongos"
if ! echo $version |fgrep -q 4.0; then
  targets="$targets mongocryptd"
fi
# mongo mongobridge mongod mongos
# requires python2 on 4.0 and python3 on 4.2
nice ./buildscripts/scons.py --disable-warnings-as-errors $jopt $targets

for i in $targets; do
  strip $i
done

subdir=`echo $branch |sed -e s/^v//`
if test $subdir = master; then
  subdir=4.4
fi

rsync -av ~/debs/mongo/$subdir/ ~/debs/mongo/$subdir-prev
rm -r ~/debs/mongo/$subdir/
mkdir ~/debs/mongo/$subdir/
cp mongo* ~/debs/mongo/$subdir/
