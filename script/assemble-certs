#!/bin/sh

# Assembles certificates and private key files generated by
# https://github.com/mcguinness/janky-ca

set -e

from="$1"

if test -z "$from"; then
  echo "Usage: `basename $0` ca-path" 1>&2
  exit 4
fi

shift

if ! test -d "$from"; then
  echo "$from does not exist" 1>&2
  exit 4
fi

if ! test -d "$from"/certs; then
  echo "$from/certs does not exist" 1>&2
  exit 4
fi

if ! test -d "$from"/private; then
  echo "$from/private does not exist" 1>&2
  exit 4
fi

mkdir -p cert
cat "$from"/certs/intermediate_ca.pem "$from"/certs/root_ca.pem >cert/ca.pem

for f in "$from"/private/*.pfx; do
  name=`echo $f |sed -e s/.pfx$//`
  bn=`basename "$name"`
  echo "$bn"
  cat "$name".pem cert/ca.pem >cert/"$bn".pem
done
